package lexek.wschat.db;

import com.google.common.collect.ImmutableList;
import lexek.wschat.db.jdbc.JdbcDataBase;
import lexek.wschat.db.jooq.tables.pojos.Room;
import org.jooq.DSLContext;
import org.jooq.exception.DataAccessException;
import org.jooq.impl.DSL;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.sql.Connection;
import java.sql.SQLException;
import java.util.List;

import static lexek.wschat.db.jooq.tables.Room.ROOM;


public class RoomHelper {
    private final JdbcDataBase dataBase;
    private final Logger logger = LoggerFactory.getLogger(RoomHelper.class);

    public RoomHelper(JdbcDataBase dataBase) {
        this.dataBase = dataBase;
    }

    public void add(Room room) {
        try (Connection connection = dataBase.getConnection()) {
            DSLContext ctx = DSL.using(connection);
            long id = ctx
                    .insertInto(ROOM, ROOM.NAME, ROOM.TOPIC)
                    .values(room.getName(), room.getTopic())
                    .returning(ROOM.ID)
                    .fetchOne().getId();
            room.setId(id);
        } catch (SQLException | DataAccessException e) {
            logger.error("sql exception", e);
        }
    }

    public List<Room> getAll() {
        List<Room> result = ImmutableList.of();
        try (Connection connection = dataBase.getConnection()) {
            DSLContext ctx = DSL.using(connection);
            result = ctx
                    .select()
                    .from(ROOM)
                    .fetch()
                    .into(Room.class);
        } catch (SQLException | DataAccessException e) {
            logger.error("sql exception", e);
        }
        return result;
    }

    public void delete(String name) {
        try (Connection connection = dataBase.getConnection()) {
            DSLContext ctx = DSL.using(connection);
            ctx
                    .delete(ROOM)
                    .where(ROOM.NAME.equal(name))
                    .execute();
        } catch (SQLException | DataAccessException e) {
            logger.error("sql exception", e);
        }
    }
}
